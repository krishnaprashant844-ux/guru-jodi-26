name: Build APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: ${{ runner.home }}/Android/Sdk
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OS packages
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            unzip zip git wget build-essential python3-pip \
            libssl-dev libffi-dev libncurses5-dev libncursesw5-dev \
            libsqlite3-dev zlib1g-dev libbz2-dev liblzma-dev pkg-config \
            openjdk-17-jdk

      - name: Create Android SDK directory
        run: mkdir -p "$ANDROID_SDK_ROOT"

      - name: Install Android command-line tools (sdkmanager)
        run: |
          set -eux
          cd /tmp
          # download command line tools (Google link may change over time)
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          # put the extracted folder under 'latest' so sdkmanager path is stable
          if [ -d "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" ]; then
            mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          fi
          chmod -R a+rwx "$ANDROID_SDK_ROOT"
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          # show sdkmanager version
          "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --version

      - name: Install Android SDK packages (platform-tools, build-tools, platforms, ndk)
        env:
          ANDROID_SDK_ROOT: ${{ runner.home }}/Android/Sdk
        run: |
          set -eux
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          # Accept licenses and install required packages.
          # Install explicit build tools 33.0.2 (aidl lives in build-tools/<version>/aidl)
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;25.1.8937393" || true
          # confirm installed
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --list

      - name: Add Android tools to PATH
        run: |
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

      - name: Upgrade pip & install buildozer + cython
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip3 install --upgrade cython buildozer==1.8.1

      - name: Ensure buildozer spec exists
        run: |
          if [ ! -f buildozer.spec ]; then
            echo "ERROR: buildozer.spec not found in repo root" >&2
            exit 1
          fi
          # show spec summary
          grep -E 'android.api|android.ndk|android.build_tools|requirements' -n buildozer.spec || true

      - name: Run buildozer (create debug APK)
        env:
          ANDROID_SDK_ROOT: ${{ runner.home }}/Android/Sdk
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
        run: |
          set -eux
          # make sure buildozer has write access and a clean start
          rm -rf ./.buildozer || true
          buildozer -v android debug
